<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="description" content="2015 in police shootings in USA">
    <meta name="keywords" content="police, shootings, killings, crime, United States, US, USA, race, guns, armed, unarmed, blacks, hispanics, white">
    <meta name="author" content="Saurabh Datar">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href= "./style.css" />
    <title> 2015 in police shootings </title>
    <style>

      body {
        background: #f6f6f6;
      }
      
      h1 {
        font-size: 52px;
      }

      span {
        background-color: black;
        color: white;
      }

      @media (max-width: 768px) {

        h1 {
          font-size: 36px;
        }

        h4 {
          font-size: 14;
        }
      }

    </style>
  </head>
  
  <body>
    <div class="container">
      <div class="page-header">
        <h1 id="heading"> 2015 in Police Shootings</h1>
      </div>
        <h4> According to the Washington Post, police in the United States shot dead <span>981 people</span> in the year 2015. The calendar below shows how many people were killed on each day. Point your mouse at any date to know the number of people killed on that day.</h4>

        <p>Inspired by <a href="http://bl.ocks.org/KathyZ/c2d4694c953419e0509b"> this calendar. </a> </p>
        <p>Data source: <a href = "https://github.com/washingtonpost/data-police-shootings"> Washington Post </a> </p>
        

      <div id="chart" class="clearfix"></div>
    </div>

      <script src="http://d3js.org/d3.v3.js"></script>
      <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
      <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
      <script>
          var width = 960,
              height = 750,
              cellSize = 25; // cell size

          var no_months_in_a_row = Math.floor(width / (cellSize * 7 + 50));
          var shift_up = cellSize * 3;

          var day = d3.time.format("%w"), // day of the week
              day_of_month = d3.time.format("%e") // day of the month
              day_of_year = d3.time.format("%j")
              week = d3.time.format("%U"), // week number of the year
              month = d3.time.format("%m"), // month number
              year = d3.time.format("%Y"),
              percent = d3.format(".1%"),
              format = d3.time.format("%Y-%m-%d");

          var color = d3.scale.quantize()
              .domain([1, 10])
              .range(d3.range(9).map(function(d) { return "q" + d + "-9"; })); //coloring bucket

          var svg = d3.select("#chart").selectAll("svg")
              .data(d3.range(2015, 2016))
            .enter().append("svg")
              .attr("width", width)
              .attr("height", height)
              .attr("class", "YlOrRd")
              .append("g")

              //make the rectangles for days
          var rect = svg.selectAll(".day")
              .data(function(d) { 
                return d3.time.days(new Date(d, 0, 1), new Date(d + 1, 0, 1));
              })
            .enter().append("rect")
              .attr("class", "day")
              .attr("width", cellSize)
              .attr("height", cellSize)
              .attr("x", function(d) {
                var month_padding = 1.2 * cellSize*7 * ((month(d)-1) % (no_months_in_a_row));
                return day(d) * cellSize + month_padding; 
              })
              .attr("y", function(d) { 
                var week_diff = week(d) - week(new Date(year(d), month(d)-1, 1) );
                var row_level = Math.ceil(month(d) / (no_months_in_a_row));
                return (week_diff*cellSize) + row_level*cellSize*8 - cellSize/2 - shift_up;
              })
              .datum(format);

          var month_titles = svg.selectAll(".month-title")  // Jan, Feb, Mar and the whatnot
                .data(function(d) { 
                  return d3.time.months(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
              .enter().append("text")
                .text(monthTitle)
                .attr("x", function(d, i) {
                  var month_padding = 1.2 * cellSize*7* ((month(d)-1) % (no_months_in_a_row));
                  return month_padding;
                })
                .attr("y", function(d, i) {
                  var week_diff = week(d) - week(new Date(year(d), month(d)-1, 1) );
                  var row_level = Math.ceil(month(d) / (no_months_in_a_row));
                  return (week_diff*cellSize) + row_level*cellSize*8 - cellSize - shift_up;
                })
                .attr("class", "month-title")
                .attr("d", monthTitle);

          
          //Load the data
          d3.csv("data.csv", function(error, csv) {
            var data = d3.nest()
              .key(function(d) { return d.date; }) //extract it by data
              .rollup(function(d) { return d.length; }) //calculate number of killings per day
              .map(csv);

              console.log(data)

          // var race = d3.nest()
          //     .key(function(d) { return d.date; })
          //     .rollup(function(d) { 
          //         return d.map(function (elm) {
          //           return elm['race'];
          //       }); 
          //     })
          //     .map(csv);
          //console.log(race)

            rect.filter(function(d) { return d in data; })
                .attr("class", function(d) { return "day " + color(data[d]); }) //color it according to killings
                .attr("cursor", "pointer");

            // rect.filter(function(d){return d in race;})
            // .append("text")
            // .text(function(d) {
            //     console.log(d)
              // if (race[d].length > 1) {console.log('M');}              
              // else {console.log(race[d][0]);}

            //});

            //  Tooltip
            var tooltip = d3.tip()
              .attr('class', 'd3-tip')
              .html(function(d) {
                if (data[d] != undefined) {
                  {
                    if (data[d] == 1)
                      {return data[d] + " person killed"; } 
                    else 
                      { return data[d] + " persons killed"; }
                  }  
              }
         });

            svg.call(tooltip); //call tooltip

            rect.on("mouseover", tooltip.show);
            rect.on("mouseout", tooltip.hide);
            
      });

          function dayTitle (t0) {
            return t0.toString().split(" ")[2];
          }
          function monthTitle (t0) {
            return t0.toLocaleString("en-us", { month: "long" });
          }
          function yearTitle (t0) {
            return t0.toString().split(" ")[3];
          }
      </script>   
  </body>
</html>